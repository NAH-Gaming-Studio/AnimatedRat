<!DOCTYPE html>
<!-- saved from url=(0114)https://torchinsky.me/shader-animation-unity/?fbclid=IwAR3Uudp-4YHvDVCY9yEIJ_wZ5HAxHvxnrwXp1pcuITmpSUDZORbn4OD1wsQ -->
<html lang="en-us"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="x-ua-compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Creating shader animation in Unity - torch in sky</title><meta name="description" content="In this blog-post I will explain how to animate simple creatures using vertex shader. I will use rat as an example, but the same method can be used to animate fishes, birds, bats and other small creatures that are not the main focus of the player."><meta name="author" content="Andrey Torchinsky"><link href="./Creating shader animation in Unity - torch in sky_files/an-old-hope.min.css" rel="stylesheet"><link href="./Creating shader animation in Unity - torch in sky_files/style.css" rel="stylesheet"><link rel="apple-touch-icon" href="https://torchinsky.me/apple-touch-icon.png"><link rel="icon" href="https://torchinsky.me/favicon.ico"><meta name="generator" content="Hugo 0.58.3"><link rel="alternate" type="application/atom+xml" href="https://torchinsky.me/index.xml" title="torch in sky"><script type="application/javascript">var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-148716317-1','auto');ga('send','pageview');}</script><script async="" src="./Creating shader animation in Unity - torch in sky_files/analytics.js.download"></script><meta property="og:title" content="Creating shader animation in Unity"><meta property="og:description" content="In this blog-post I will explain how to animate simple creatures using vertex shader. I will use rat as an example, but the same method can be used to animate fishes, birds, bats and other small creatures that are not the main focus of the player."><meta property="og:type" content="article"><meta property="og:url" content="https://torchinsky.me/shader-animation-unity/"><meta property="article:published_time" content="2020-06-15T15:09:13+02:00"><meta property="article:modified_time" content="2020-06-16T16:34:29+02:00"><script>function setTheme(){const time=new Date();const prev=localStorage.getItem('date');const date=String(time.getMonth()+1)+'.'+String(time.getDate());const now=time.getTime();let sunrise;let sunset;function setBodyClass(){if(now>sunrise&&now<sunset)return;document.body.classList.add('dark');}
if(date!==prev){fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215').then(res=>res.json()).then(data=>{sunrise=data.sunrise.split(':').map(Number);sunset=data.sunset.split(':').map(Number);}).catch(()=>{sunrise=[7,0];sunset=[19,0];}).finally(()=>{sunrise=time.setHours(sunrise[0],sunrise[1],0);sunset=time.setHours(sunset[0],sunset[1],0);setBodyClass();localStorage.setItem('sunrise',sunrise);localStorage.setItem('sunset',sunset);});localStorage.setItem('date',date);}else{sunrise=Number(localStorage.getItem('sunrise'));sunset=Number(localStorage.getItem('sunset'));setBodyClass();}}</script></head><body class="single dark" data-gr-c-s-loaded="true"><script>setTheme();</script><header class="header"><nav class="nav"><p class="logo"><a href="https://torchinsky.me/">torch in sky</a></p><ul class="menu"><li><a href="https://store.steampowered.com/app/1318020/">Steam Page</a></li><li><a href="https://torchinsky.me/categories/">Categories</a></li><li><a href="https://torchinsky.me/tags/">Tags</a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><h1 class="post-title">Creating shader animation in Unity</h1><div class="post-meta">Andrey Torchinsky · June 15, 2020</div></header><div class="post-content"><p>Recently I was working on respawn animation and FX for the main character in my game <a href="https://store.steampowered.com/app/1318020/">“King, Witch and Dragon”</a>. For this FX I needed a couple hundreds of animated rats.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/lzsriS6.gif" alt="Respawn animation and FX"></center><p></p><p>Create 200 <em>Skinned Meshes</em> with keyframe-animation just for 1 FX is a waste of resourses. I decided to use particle systems instead, but to do so I had to apply different approach to animation.</p><p>In this blog-post I will explain how to animate simple creatures using <strong>vertex shader</strong>. I will use rat as an example, but the same method can be used to animate fishes, birds, bats and other small creatures that are not the main focus of the player.</p><p>Most of the beginner tutorials about shader animation explain how to animate flag using sine wave. I’m going to show a bit more complex version where we will split our model into different body parts and animate them separately.</p><p>The animation that I’m going to deconstruct is this one:</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/f8eHnAT.gif" alt="Rat animation"></center><p></p><h1 id="preparation">Preparation</h1><p>To start I created low-poly model of the rat in Blender.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/ZBpCz56.png" alt="Rat model"></center><p></p><p>To split model into different parts (body, tail, legs) I’m using <strong>UV-coordinates</strong>. To make it work the model should be unwrapped in a specific way.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/G5qRVZC.png" alt="Rat UV"></center><p></p><p>The main movement of the rat is jump. To make all the vertices animate smoothly and synchronously we need to place the whole body of the rat along one of the axis. For the convenience I put it along horizontal U-axis.</p><p>The eyes, inner part of the ear and nose all should have different color on the texture, so I placed them separately but keeping offset <strong>only in Y-axis</strong> without changing horizontal coordinates. If we move them in horizontal axis then their movement <strong>won’t be synchronized</strong> with the head movement.</p><p>Rat’s tail occupies the left half of the unwrap (U-coordinates from 0.0 to 0.5). This is going to be our <strong>tail mask</strong> that we will use for tail animation.</p><p>Legs are placed on the lower half of the unwrap (V-coordinates from 0.0 to 0.4). This is our <strong>legs mask</strong>. Legs are also collapsed in horizontal U-axis to prevent unwanted deformation when moving back and forth. Since in my project I’m using <a href="https://torchinsky.me/cel-shading/">cel-shading</a> without detailed texture, collapsed UVs is not a problem.</p><p>Based on this UV-unwrap I created <strong>diffuse texture</strong>. Now we can start working on shader.</p><p>If you want to follow along you can download FBX-model with diffuse texture from <strong><a href="http://torchinsky.me/files/KWaD-Rat.zip">here</a></strong>.</p><h1 id="creating-shader">Creating shader</h1><p>I will create this shader in Unity <strong>Shader Graph</strong> first and then show text version.</p><p>Let’s create <strong>Unlit Graph</strong>, as a <strong>Preview</strong> choose <strong>Custom Mesh</strong> and select our rat model.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/4tBLFIh.png"><img src="./Creating shader animation in Unity - torch in sky_files/4tBLFIh.png" alt="Graph start"></a></p><h2 id="apply-texture">Apply texture</h2><p>Create new <strong>Texture 3D</strong> parameter, this will be our main diffuse texture. Create <strong>Sample Texture 2D</strong> node, connect our new parameter to the <em>texture</em> field and then connect node to the <em>Color</em> field of the Master node.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/kVUwSlz.png"><img src="./Creating shader animation in Unity - torch in sky_files/kVUwSlz.png" alt="Graph diffuse texture"></a></p><p>From now on we will work only with vertices.</p><h2 id="the-main-movement">The main movement</h2><p>We will create it using <strong>Sine wave</strong>. To tweak the shape of the wave we will need 3 parameters:</p><ul><li><strong>Jump Amplitude</strong> - how high the rat will jump</li><li><strong>Jump Frequency</strong> - how often the rat will perform jumps</li><li><strong>Jump Speed</strong> - how fast will be movement along vertical axis</li></ul><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/R3fcZmLl.png" alt="Jump parameters"></center><p></p><p>The 2 main nodes that will allow us to create animated movement are <strong>Time</strong> and <strong>UV</strong>. For the <strong>UV</strong> we will need to use each axis separately, so we will connect it to <strong>Split</strong> node that will give us access to each channel.</p><p>We can control sine wave scrolling speed by multiplying <strong>Time</strong> node by <strong>Jump Speed</strong> parameter.</p><p>If we multiply <strong>horizontal component of the UV</strong> by <strong>Jump Frequency</strong> we can control squash and stretch of the sine wave.</p><p>The sum of these products will give us sine wave of the desired shape. By default sine wave returns values between -1.0 and 1.0. If we multiply it by <strong>Jump Amplitude</strong> we will get our jump trajectory.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/Egi4DDHl.png"><img src="./Creating shader animation in Unity - torch in sky_files/Egi4DDHl.png" alt="Building sive wave"></a></p><p>Now we need to apply the result to the vertex position, but only to it’s <strong>vertical component</strong> (local Y-axis). We will use <strong>Position</strong> node and connect it to <strong>Split</strong> node. Then we will add the value from the sine wave to the Y-component and assemble everything back using <strong>Combine</strong> node. Plug the output of this node to the <em>Vertex Position</em> field of our Master node.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/z1PTfLil.png"><img src="./Creating shader animation in Unity - torch in sky_files/z1PTfLil.png" alt="Apply Y-offset"></a></p><p>Our rat started to move, but not exactly in the way we would like to. More like a dolphin rather than rat.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/MygZSag.gif" alt="Rat sine wave"></center><p></p><p>As I mentioned before, sine wave can return both positive and negative values. If we now place our rat on the surface it will “dive” into it. Also, sive wave has very smooth extremes, that’s why our animation looks like swimming.</p><p>To fix this we will use <strong>Absolute</strong> node. This function mirrors all the negative values to the positive ones and the output of this function is <strong>always positive</strong>.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/6q4mWqY.png" alt="Absolute values of the sine wave"></center>
<em>At the top there are normal values, at the bottom - absolute.</em><p></p><p>Let’s add this node to our graph.</p><p></p><center><a href="./Creating shader animation in Unity - torch in sky_files/dDIElEX.png"><img src="./Creating shader animation in Unity - torch in sky_files/dDIElEX.png" alt="Graph absolute node"></a></center><p></p><p>Now our animatiom is more bouncy.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/1QjUXrp.gif" alt="Rat absolute sine wave"></center><p></p><p>It looks more like jumps or hops, but still far from what we need. Right now the problem is that as soon as legs touch the ground they bounce back in the air. It makes sense if we look at our sine wave, but it doesn’t make sense from the rat movement perspective. Let’s keep rat’s legs on the ground for a while before next hop.</p><p>To do so we will modify our sine wave once again. Let’s move it down along vertical axis and then take maximum value between sine and zero.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/k949HoJ.png" alt="Sine wave vertical offset"></center>
<em>At the top - absolute value, in the middle - with offset, at the bottom - maximum between sine and zero.</em><p></p><p>To implement in our graph we will need new parameter <strong>Jump Vertical Offset</strong> that will allow us to tweak how much we want to move our sine wave.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/QplWtn9.png"><img src="./Creating shader animation in Unity - torch in sky_files/QplWtn9.png" alt="Graph abs sine offset"></a></p><p>Now our rat stay on the ground for a bit.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/TpjI3Qc.gif" alt="Rat jump with vertical offset"></center><p></p><h2 id="tail-extra-swing">Tail extra swing</h2><p>In general it doesn’t look so bad already, but the tail always dangles close to the ground. Let’s add a bit more energy to it.</p><p>We will use UV-coordinates to mask the tail and animate it separately from the rest of the body.</p><p>We know that the tail is located in the left half of the UV-unwrap. We will create smooth gradient from 0.0 to 0.5 (or even to 0.6 for smoother effect) on the horizontal U-axis. At 0.0 we will have white color, at 0.6 and further - black. The brighter pixel on the gradient, the more extra movement will be applied to the vertex. Basically, the tail’s tip will affected the most and then effect will fade out closer to the body.</p><p>We will use <strong>Smooth Step</strong> node to create this gradient.</p><p>We also will need new parameter <strong>Tail Extra Swing</strong> to define how much movement to add.</p><p>Multiplying this new parameter by the output of the <strong>Smooth Step</strong> node we will get movement distribution along the tail. Then we will add this to our <strong>Jump Amplitude</strong> parameter to get final body movement that takes into account extra tail swing.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/gpq2BgZ.png"><img src="./Creating shader animation in Unity - torch in sky_files/gpq2BgZ.png" alt="Graph tail mask"></a></p><p><a href="./Creating shader animation in Unity - torch in sky_files/q3BWLCf.png"><img src="./Creating shader animation in Unity - torch in sky_files/q3BWLCf.png" alt="Graph tail mask full"></a></p><p>Now tail’s movement is more noticable (<strong>Tail Extra Swing</strong> = 0.3).</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/A6CUMJa.gif" alt="Rat extra tail swing"></center><p></p><h2 id="legs-movement">Legs movement</h2><p>For the legs movement we’re going to use similar structure as for the body. We will need a couple more new parameters:</p><ul><li><strong>Legs Amplitude</strong> - how far legs will move from their default positions</li><li><strong>Legs Frequency</strong> - how often legs are going to move</li></ul><p>We don’t need <strong>Legs Speed</strong> parameter because legs movement should be synced with body movement, so we will reuse <strong>Jump Speed</strong> parameter. The only thing to keep in mind here is that because we use absolute value of the sine wave in one cycle we have 2 jumps. So we will use <strong>Jump Speed * 2</strong> to compensate it.</p><p>Legs should move back and forth (both positive and negative offset) so we won’t need <strong>Absolute</strong> node in this case.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/guGOQKQ.png"><img src="./Creating shader animation in Unity - torch in sky_files/guGOQKQ.png" alt="Graph legs sine wave"></a></p><p>Now we need to create a mask for the legs to animate them separately.</p><p>We will use <strong>Smooth Step</strong> node once again but this time we will use <strong>vertical UV axis</strong> as an <strong>in</strong>-parameter. Let’s set gradient from 0.1 to 0.4.</p><p>Why 0.1 and not 0.0? To prevent feet deformation. All vertices that are below 0.1 level will have the same offset.</p><p>We need to tweak <strong>Legs Frequency</strong> value in the way that when the front legs go forward the back legs go backward and vice versa. I my case I set value to 10.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/IOLvIFv.png"><img src="./Creating shader animation in Unity - torch in sky_files/IOLvIFv.png" alt="Graph legs mask"></a></p><p>Let’s add the result to the local Z-position of the vertices. I temporary disabled body movement to see isolated legs animation.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/ebQW4MX.png"><img src="./Creating shader animation in Unity - torch in sky_files/ebQW4MX.png" alt="Graph isolated legs movement"></a></p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/UxxH24O.gif" alt="Rat isolated legs movement"></center><p></p><p>Now let’s combine everything together and see how it looks. I intentionally decreased the speed so it will be easier to spot any problems.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/bhaZZNg.gif" alt="Rat slomo"></center><p></p><p>You can see that front legs touch the ground when they are in the far left position. That’s incorrect. They should land on the ground when they are more or less in the far right position. It means that body and legs animation phases don’t match.</p><p>To solve this issue we will create new parameter <strong>Legs Phase Offset</strong> that will allows us to compensate this phase difference and align animations.</p><p>To make this phase offset work we will add it to our <strong>Time</strong> node <strong>AFTER</strong> it’s been multiplied by <strong>Jump Speed</strong> (to keep speed the same) but <strong>BEFORE</strong> all other manipulations.</p><p><a href="./Creating shader animation in Unity - torch in sky_files/2nPRLkL.png"><img src="./Creating shader animation in Unity - torch in sky_files/2nPRLkL.png" alt="Graph phase offset"></a></p><p>After tweaking the value (in my case I set it to -1.0) we have correct animation.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/rbJ2kbO.gif" alt="Rat with phase offset"></center><p></p><p>This how it looks with normal speed.</p><p></p><center><img src="./Creating shader animation in Unity - torch in sky_files/pAUG4J5.gif" alt="Rat final"></center><p></p><p>The complete graph (click to open full-size).</p><p><a href="./Creating shader animation in Unity - torch in sky_files/v9ol3TM.png"><img src="./Creating shader animation in Unity - torch in sky_files/v9ol3TM.png" alt="Complete graph"></a></p><h2 id="text-version-of-the-shader">Text version of the shader</h2><p>For those who didn’t move to URP/HDRP yet or just prefer to write shader manually here you go:</p><pre><code class="hljs cs">Shader <span class="hljs-string">"Unlit/Rat"</span>
{
    Properties
    {
        _JumpSpeed(<span class="hljs-string">"Jump Speed"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">10</span>
        _JumpAmplitude(<span class="hljs-string">"Jump Amplitude"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">0.18</span>
        _JumpFrequency(<span class="hljs-string">"Jump Frequency"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">2</span>
        _JumpVerticalOffset(<span class="hljs-string">"Jump Vertical Offset"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">0.33</span>
        _TailExtraSwing(<span class="hljs-string">"Tail Extra Swing"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">0.15</span>
        _LegsAmplitude(<span class="hljs-string">"Legs Amplitude"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">0.10</span>
        _LegsFrequency(<span class="hljs-string">"Legs Frequency"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">10</span>
        _LegsPhaseOffset(<span class="hljs-string">"Legs Phase Offset"</span>, <span class="hljs-keyword">float</span>) = <span class="hljs-number">-1</span>
        [<span class="hljs-meta">NoScaleOffset</span>]
        _MainTex (<span class="hljs-string">"Texture"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> {}
    }
    SubShader
    {
        Tags { <span class="hljs-string">"RenderType"</span>=<span class="hljs-string">"Opaque"</span> }
        LOD <span class="hljs-number">100</span>

        Pass
        {
            CGPROGRAM
            <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> vertex vert</span>
            <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> fragment frag</span>

            <span class="hljs-meta">#include "UnityCG.cginc"</span>

            <span class="hljs-keyword">struct</span> appdata
            {
                float4 vertex : POSITION;
                float2 uv : TEXCOORD0;
            };

            <span class="hljs-keyword">struct</span> v2f
            {
                float2 uv : TEXCOORD0;
                float4 vertex : SV_POSITION;
            };

            sampler2D _MainTex;
            float4 _MainTex_ST;
            half _JumpSpeed;
            half _JumpAmplitude;
            half _JumpFrequency;
            half _JumpVerticalOffset;
            half _TailExtraSwing;
            half _LegsAmplitude;
            half _LegsFrequency;
            half _LegsPhaseOffset;

            <span class="hljs-function">v2f <span class="hljs-title">vert</span> (<span class="hljs-params">appdata v</span>)</span>
            {
                <span class="hljs-keyword">float</span> bodyPos = max((abs(sin(_Time.y * _JumpSpeed + v.uv.x * _JumpFrequency)) - _JumpVerticalOffset), <span class="hljs-number">0</span>);
                <span class="hljs-keyword">float</span> tailMask = smoothstep(<span class="hljs-number">0.6</span>, <span class="hljs-number">0.0</span>, v.uv.x) * _TailExtraSwing + _JumpAmplitude;
                bodyPos *= tailMask;
                v.vertex.y += bodyPos;

                <span class="hljs-keyword">float</span> legsPos = sin(_Time.y * _JumpSpeed * <span class="hljs-number">2</span> + _LegsPhaseOffset + v.uv.x * _LegsFrequency) * _LegsAmplitude;
                <span class="hljs-keyword">float</span> legsMask = smoothstep(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.1</span>, v.uv.y);
                legsPos *= legsMask;
                v.vertex.z += legsPos;

                v2f o;
                o.vertex = UnityObjectToClipPos(v.vertex);
                o.uv = TRANSFORM_TEX(v.uv, _MainTex);
                <span class="hljs-keyword">return</span> o;
            }

            <span class="hljs-function">fixed4 <span class="hljs-title">frag</span> (<span class="hljs-params">v2f i</span>) : SV_Target</span>
            {
                fixed4 col = tex2D(_MainTex, i.uv);
                <span class="hljs-keyword">return</span> col;
            }
            ENDCG
        }
    }
}
</code></pre><h1 id="conclusion">Conclusion</h1><p>Congratulation! We created vertex shader that can bring simple creature to life without using skeleton rig and keyframe animations.</p><p>This approach will fit for some background objects that are not the main focus of player’s attention. This will also give you boost in performance compared to <em>Skinned Mesh Renderers</em>.</p><p>I hope you found it interestin and/or useful.</p><p>To support the project add <strong><a href="https://store.steampowered.com/app/1318020/">“King, Witch and Dragon”</a></strong> to your Steam wishlist. Follow me on <strong><a href="https://twitter.com/torch_in_sky">Twitter</a></strong> and <strong><a href="https://www.instagram.com/torch_in_sky/">Instagram</a></strong> for more updates and useful stuff.</p><p>Cheers!</p></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://torchinsky.me/tags/unity">unity</a></li><li><a href="https://torchinsky.me/tags/shader">shader</a></li><li><a href="https://torchinsky.me/tags/3d">3d</a></li><li><a href="https://torchinsky.me/tags/animation">animation</a></li><li><a href="https://torchinsky.me/tags/useful">useful</a></li><li><a href="https://torchinsky.me/tags/tutorial">tutorial</a></li></ul></footer></article></main><footer class="footer"><span>© 2020 <a href="https://torchinsky.me/">Andrey Torchinsky</a></span>
<span>·</span>
<span><a href="https://www.instagram.com/torch_in_sky/" rel="noopener" target="_blank">Instagram</a></span>
<span>·</span>
<span><a href="https://twitter.com/torch_in_sky" rel="noopener" target="_blank">Twitter</a></span>
<span>·</span>
<span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
<span>·</span>
<span>Theme️ <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper</a></span></footer><script src="./Creating shader animation in Unity - torch in sky_files/highlight.min.js.download"></script><script>hljs.initHighlightingOnLoad();</script></body></html>